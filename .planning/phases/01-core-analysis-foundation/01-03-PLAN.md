---
phase: 01-core-analysis-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - database/migrations/20260222000001_add_forensic_tier.sql
  - server/api/analyze.post.ts
  - server/utils/config.ts
autonomous: true
requirements:
  - TIER-03
  - QUEUE-01

must_haves:
  truths:
    - "Database accepts 'forensic' in analysis_type CHECK constraint"
    - "Credit cost is 10 for forensic tier (not hardcoded 3)"
    - "Worker plugin processes forensic analysis jobs correctly"
    - "Config-driven credit cost is used instead of hardcoded values"
  artifacts:
    - path: "database/migrations/20260222000001_add_forensic_tier.sql"
      provides: "Database migration for forensic tier support"
    - path: "server/api/analyze.post.ts"
      provides: "Analysis endpoint with config-driven credit costs"
  key_links:
    - from: "server/api/analyze.post.ts"
      to: "server/utils/config.ts"
      via: "getPromptConfig for credit cost"
      pattern: "getPromptConfig|tiers\\[.*\\]\\.credits"
    - from: "server/plugins/worker.ts"
      to: "server/utils/openai-client.ts"
      via: "analyzeContract function call"
      pattern: "analyzeContract.*analysisType"
---

<objective>
Update database constraints and credit cost logic to support the Forensic tier with proper 10-credit pricing.

Purpose: The current implementation has hardcoded credit costs (premium=3, everything else=1) and the database CHECK constraint only allows 'basic' or 'premium'. Both need to be updated for Forensic tier support.

Output: Database migration adding 'forensic' to CHECK constraint, and updated analyze.post.ts using config-driven credit costs.
</objective>

<execution_context>
@/home/cativo23/.claude/get-shit-done/workflows/execute-plan.md
@/home/cativo23/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-analysis-foundation/01-CONTEXT.md
@.planning/phases/01-core-analysis-foundation/01-RESEARCH.md
@database/migrations/20260216000006_add_analysis_types.sql
@server/api/analyze.post.ts
@server/utils/config.ts
@server/plugins/worker.ts
</context>

<tasks>

<task type="auto">
  <name>Create Database Migration for Forensic Tier</name>
  <files>database/migrations/20260222000001_add_forensic_tier.sql</files>
  <action>
    Create a new database migration file to add 'forensic' to the analysis_type CHECK constraint:

    1. **File naming**: Use format 20260222000001_add_forensic_tier.sql (YYYYMMDD + sequence)

    2. **Migration content**:
       - Update the CHECK constraint on analyses.analysis_type to include 'forensic'
       - The existing constraint only allows ('basic', 'premium')
       - Need to drop old constraint and add new one with ('basic', 'premium', 'forensic')

    3. **SQL structure**:
       ```sql
       -- Migration: Add Forensic Tier
       -- Date: 2026-02-22
       -- Description: Add 'forensic' to analysis_type CHECK constraint

       -- Drop old constraint
       ALTER TABLE analyses
       DROP CONSTRAINT IF EXISTS analyses_analysis_type_check;

       -- Add new constraint with forensic tier
       ALTER TABLE analyses
       ADD CONSTRAINT analyses_analysis_type_check
       CHECK (analysis_type IN ('basic', 'premium', 'forensic'));
       ```

    4. **Also update transactions table** if needed:
       - Add credit_pack_type value for 'forensic' if there's a constraint
  </action>
  <verify>
    - Migration file exists at database/migrations/20260222000001_add_forensic_tier.sql
    - Migration can be applied: npm run db:migrate
    - After migration, INSERT with analysis_type='forensic' succeeds
    - Running: psql command to verify constraint: SELECT conname, consrc FROM pg_constraint WHERE conname LIKE '%analysis_type%';
  </verify>
  <done>
    Database migration applied successfully, analyses table accepts 'forensic' as valid analysis_type.
  </done>
</task>

<task type="auto">
  <name>Fix Credit Cost Logic to Use Config-Driven Values</name>
  <files>server/api/analyze.post.ts</files>
  <action>
    Replace hardcoded credit cost logic with config-driven values in server/api/analyze.post.ts:

    1. **Current problematic code** (line 79):
       ```typescript
       const creditCost = analysis_type === "premium" ? 3 : 1;
       ```
       This deducts 3 credits for premium, 1 for everything else (including forensic!)

    2. **Import getPromptConfig**:
       ```typescript
       import { getPromptConfig } from "../utils/config";
       ```

    3. **Replace with config-driven logic**:
       ```typescript
       // Get credit cost from configuration
       const config = await getPromptConfig();
       const creditCost = config.tiers[analysis_type]?.credits || 3;
       ```

    4. **Add validation logging**:
       ```typescript
       console.log(`[Analyze] Tier: ${analysis_type}, Credits: ${creditCost}`);
       ```

    5. **Verify the RPC function call** already passes p_credit_cost correctly:
       - Current call passes creditCost to process_analysis_transaction
       - This is correct - no changes needed to RPC call
  </action>
  <verify>
    - getPromptConfig is imported in analyze.post.ts
    - creditCost uses config.tiers[analysis_type]?.credits
    - Hardcoded ternary (analysis_type === "premium" ? 3 : 1) is removed
    - TypeScript compilation passes: npm run typecheck
  </verify>
  <done>
    Credit cost is dynamically determined from configuration: basic=1, premium=3, forensic=10.
  </done>
</task>

<task type="auto">
  <name>Verify Worker Plugin Handles Forensic Tier</name>
  <files>server/plugins/worker.ts</files>
  <action>
    Review and verify the worker plugin correctly processes Forensic tier jobs:

    1. **Review current worker code** (server/plugins/worker.ts, line 67-70):
       ```typescript
       let analysisSummary = await analyzeContract(
         contractText,
         analysisType || "premium",
       );
       ```

    2. **Verify behavior**:
       - Worker already passes analysisType to analyzeContract
       - If analysisType is 'forensic', it will be passed correctly
       - The fallback to 'premium' is only if analysisType is null/undefined

    3. **Add debug logging** for Forensic jobs:
       ```typescript
       console.log(
         `[Worker] Processing ${analysisType || "premium"} analysis for job ${analysisId}`,
       );
       ```

    4. **No structural changes needed** - worker already supports all tiers
       - The analyzeContract function update (Plan 02) handles the rest
  </action>
  <verify>
    - Worker plugin passes analysisType to analyzeContract
    - Debug logging added for tier identification
    - Worker concurrency setting reviewed (currently 2 concurrent jobs)
    - No code changes required beyond logging
  </verify>
  <done>
    Worker plugin verified to correctly process Forensic tier jobs with appropriate logging.
  </done>
</task>

</tasks>

<verification>
- Database migration file created and can be applied
- analyses table accepts 'forensic' in analysis_type column
- Credit cost for forensic is 10 credits (from config)
- Credit cost for premium is 3 credits
- Credit cost for basic is 1 credit
- Worker plugin correctly processes forensic analysis jobs
</verification>

<success_criteria>
- Running `npm run db:migrate` applies forensic tier migration successfully
- analyze.post.ts uses config-driven credit costs
- Worker logs show correct tier processing
- Full flow works: upload → analyze(forensic) → 10 credits deducted → results saved
</success_criteria>

<output>
After completion, create .planning/phases/01-core-analysis-foundation/01-03-SUMMARY.md
</output>

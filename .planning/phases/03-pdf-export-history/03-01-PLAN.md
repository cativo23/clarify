---
phase: 03-pdf-export-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - server/utils/pdf-generator.ts (NEW)
  - server/api/analyses/[id]/export-pdf.get.ts (NEW)
  - pages/analyze/[id].vue
  - pages/history.vue
autonomous: true
requirements:
  - PDF-01
  - HISTORY-01
  - HISTORY-02
---

# Plan 03-01: PDF Export & History Filters Implementation

## Goal
Implement PDF export for analysis results and enhance history page with date range filters.

## Must Haves (from phase success criteria)
1. User can download analysis results as formatted PDF report with branded header, risk summary, and key clauses
2. User can search and filter their analysis history by risk level and date range
3. PDF includes Clarify branding (secondary green #00dc82), risk colors, and legal disclaimer

## Context
- **pdfkit** is NOT installed - needs to be added as dependency
- History page (`/pages/history.vue`) has search and risk filters working
- History page needs date range filter (FROM/TO date pickers)
- Analysis detail page (`/pages/analyze/[id].vue`) has `downloadPDF()` stub at line 774-777
- Existing PDF script (`scripts/generate-contract-pdfs.cjs`) shows pdfkit usage pattern
- API endpoints use Supabase client with proper auth and RLS

## Tasks

### Task 1: Install pdfkit dependency
Add pdfkit to package.json dependencies:
```json
"pdfkit": "^0.16.0"
```
Run `npm install` to install the package.

### Task 2: Create PDF Generator Utility
Create `/server/utils/pdf-generator.ts` with:
- Function `generateAnalysisPDF(analysis: Analysis, summary: AnalysisSummary): Promise<Buffer>`
- A4 page size with margins (50px all sides)
- **Header**: Clarify text logo (secondary green #00dc82), contract name, analysis date
- **Risk Badge**: Traffic light colors (high=#ef4444, medium=#f59e0b, low=#10b981)
- **Executive Summary**: Verdict, justification, metrics (total rojas/amarillas/verdes)
- **Hallazgos Section**: Loop through all hallazgos with risk-colored left border
- **Forensic Sections**: Render analisis_cruzado, omisiones, mapa_estructural if present
- **Footer**: Legal disclaimer ("No constituye asesor√≠a legal profesional"), page numbers
- Use built-in Helvetica font (no custom font files needed for MVP)
- Return PDF as Buffer for storage/upload

### Task 3: Create PDF Export API Endpoint
Create `/server/api/analyses/[id]/export-pdf.get.ts`:
- **Authentication**: Require auth, verify user owns analysis (`.eq("user_id", user.id)`)
- **Rate Limiting**: Apply standard rate limit (10 req/min per user)
- **Cache Check**: Query Supabase Storage `pdfs` bucket for existing PDF
- **If Cached**: Generate signed URL (24h expiry), return `{ url, cached: true }`
- **If Not Cached**:
  - Fetch full analysis data
  - Call `generateAnalysisPDF()` utility
  - Upload to Supabase Storage at `pdfs/[user_id]/[analysis_id].pdf`
  - Generate signed URL
  - Return `{ url, cached: false }`
- **Error Handling**: Use `handleApiError` utility, strip debug info for non-admin

### Task 4: Update Analysis Detail Page
Update `/pages/analyze/[id].vue`:
- Replace `downloadPDF()` stub with real implementation
- Call `/api/analyses/[id]/export-pdf` endpoint
- Create temporary `<a>` tag with `download` attribute
- Trigger click to start download
- Show loading state during PDF generation
- Handle errors with user-friendly alert
- Add toast notification on successful download

### Task 5: Add Date Range Filters to History Page
Update `/pages/history.vue`:
- Add state: `const dateFrom = ref<string>('')`, `const dateTo = ref<string>('')`
- Add native `<input type="date">` elements in filter bar (after search, before risk buttons)
- Update `filteredAnalyses` computed to include date filtering:
  ```typescript
  const matchesDateFrom = !dateFrom.value || new Date(a.created_at) >= new Date(dateFrom.value)
  const matchesDateTo = !dateTo.value || new Date(a.created_at) <= new Date(dateTo.value)
  ```
- Add "Clear all filters" functionality (reset searchQuery, activeFilter, dateFrom, dateTo)
- Update empty state message to mention active filters
- Style date inputs to match existing filter bar aesthetic (rounded-xl, bg-slate-50, etc.)

### Task 6: Create Supabase Storage Bucket for PDFs
Document bucket creation (manual step via Supabase Dashboard):
- Bucket name: `analysis-pdfs`
- Public: false (private, signed URLs only)
- File size limit: 10MB (more than enough for PDFs)
- RLS Policy: Allow authenticated users to read/write their own files (`user_id` matches)

### Task 7: Test PDF Generation
Test with all analysis types:
- Basic analysis (simple PDF)
- Premium analysis (standard PDF)
- Forensic analysis (includes cross-clause, omissions, structural map sections)
- Verify branding colors appear correctly
- Verify legal disclaimer in footer
- Verify all hallazgos are included
- Test caching behavior (second download should be faster)

### Task 8: Test History Filters
Test filter combinations:
- Date range only (FROM and TO)
- Risk filter only
- Search + risk + date combined
- Empty states (no results match)
- "Clear all filters" resets everything
- Filter persistence during page navigation

## Verification Criteria

**PDF Export (PDF-01):**
- [ ] Clicking "Descargar Reporte (PDF)" initiates browser download
- [ ] PDF file is named appropriately (e.g., `clarify-contrato-2026-02-24.pdf`)
- [ ] PDF header shows Clarify branding in secondary green (#00dc82)
- [ ] Risk badge uses correct traffic light color
- [ ] Executive summary includes verdict, justification, and metrics
- [ ] All hallazgos appear in PDF with risk-colored left borders
- [ ] Forensic analyses include analisis_cruzado, omisiones, mapa_estructural sections
- [ ] Footer includes legal disclaimer and page numbers
- [ ] Second download of same analysis uses cached PDF (faster)
- [ ] User cannot download another user's PDF (security check)

**History Filters (HISTORY-01, HISTORY-02):**
- [ ] Search by contract name works (case-insensitive)
- [ ] Risk level filter shows correct results (All/Fallidos/Riesgo Alto/Cuidado/Seguro)
- [ ] Date FROM filter excludes earlier analyses
- [ ] Date TO filter excludes later analyses
- [ ] Combined filters apply AND logic (all must match)
- [ ] Empty state shows friendly message with "Clear filters" button
- [ ] "Clear all filters" resets search, risk, and date filters
- [ ] Date inputs styled consistently with existing filter bar

## Implementation Notes

**PDF Layout Structure:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CLARIFY (secondary green)          ‚îÇ
‚îÇ  CONTRATO DE EJEMPLO                ‚îÇ
‚îÇ  Analizado: 24 Feb 2026             ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  NIVEL DE RIESGO: [ALTO] üî¥         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ RESUMEN EJECUTIVO                   ‚îÇ
‚îÇ Veredicto: Negociar/Rechazar        ‚îÇ
‚îÇ Justificaci√≥n: [text]               ‚îÇ
‚îÇ M√©tricas: üî¥ 5  üü° 3  üü¢ 12         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AN√ÅLISIS POR CL√ÅUSULA               ‚îÇ
‚îÇ 1. Cl√°usula de Jurisdicci√≥n         ‚îÇ
‚îÇ    [Explicaci√≥n + Riesgo + Mitigaci√≥n]
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚ö†Ô∏è NOTA LEGAL                       ‚îÇ
‚îÇ Este an√°lisis es una gu√≠a           ‚îÇ
‚îÇ informativa generada por IA...      ‚îÇ
‚îÇ                            P√°gina 1 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Storage Path Convention:**
- Bucket: `analysis-pdfs`
- Path: `[user_id]/[analysis_id].pdf`
- Signed URL expiry: 24 hours

**Color Reference (from tailwind.config.js):**
- Secondary: `#00dc82` (Nuxt Green)
- Risk High: `#ef4444` (Red)
- Risk Medium: `#f59e0b` (Amber)
- Risk Low: `#10b981` (Green)

**Security Considerations:**
- Ownership verification in PDF endpoint (`.eq("user_id", user.id)`)
- Rate limiting to prevent abuse (10 req/min standard)
- Signed URLs with 24h expiry prevent URL sharing
- RLS policies on Storage bucket enforce user isolation

## Files to Create/Modify

**New Files:**
- `/server/utils/pdf-generator.ts` - PDF generation logic
- `/server/api/analyses/[id]/export-pdf.get.ts` - API endpoint

**Modified Files:**
- `/package.json` - Add pdfkit dependency
- `/pages/analyze/[id].vue` - Implement downloadPDF()
- `/pages/history.vue` - Add date range filters

**Manual Setup:**
- Create Supabase Storage bucket `analysis-pdfs` (private, signed URLs)
- Add RLS policy for bucket (users can only access their own PDFs)

## Estimated Complexity
**LOW-MEDIUM** - Well-documented patterns, pdfkit precedent exists, no novel infrastructure

## Dependencies
- pdfkit (to be installed)
- Supabase Storage (already configured, just need new bucket)

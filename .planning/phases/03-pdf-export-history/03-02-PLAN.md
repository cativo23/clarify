---
wave: 2
depends_on:
  - 03-01
files_modified:
  - tests/e2e/pdf-export.spec.ts (NEW)
  - tests/e2e/history-filters.spec.ts (NEW)
  - tests/unit/pdf-generator.test.ts (NEW)
autonomous: true
requirements:
  - PDF-01
  - HISTORY-01
  - HISTORY-02
---

# Plan 03-02: PDF Export & History Filters Testing

## Goal
Comprehensive testing of PDF export functionality and history filter enhancements to ensure quality and prevent regressions.

## Must Haves
1. E2E tests verify PDF download flow works end-to-end
2. E2E tests verify history filters (search, risk, date range) work correctly
3. Unit tests verify PDF generator produces correct output structure
4. Manual testing checklist for QA verification

## Context
- Phase 3 implements PDF export and history date filters
- PDF generation uses pdfkit server-side
- History filtering is client-side (Vue computed properties)
- Existing test infrastructure: Vitest (unit), Playwright (E2E)

## Tasks

### Task 1: Create PDF Generator Unit Tests
Create `/tests/unit/pdf-generator.test.ts`:
- **Test**: PDF generator creates valid Buffer
- **Test**: Header contains Clarify branding text
- **Test**: Risk badge uses correct color for each risk level
- **Test**: All hallazgos are included in PDF
- **Test**: Forensic sections render when data present
- **Test**: Footer contains legal disclaimer
- **Test**: Page numbers appear on all pages
- Mock analysis data with known values for deterministic tests
- Use Vitest test framework (already configured)

### Task 2: Create PDF Export E2E Tests
Create `/tests/e2e/pdf-export.spec.ts`:
- **Test**: User can download analysis PDF from detail page
  - Login with test user
  - Navigate to analysis detail page
  - Click "Descargar Reporte (PDF)" button
  - Verify download starts (file received)
- **Test**: PDF is cached after first generation
  - Generate PDF first time (measure response time)
  - Generate PDF second time (should be faster, cached: true)
  - Compare response times
- **Test**: Security - user cannot download another user's PDF
  - Login as User A
  - Try to access User B's analysis PDF
  - Verify 404 or 403 error
- **Test**: PDF download works for Basic, Premium, and Forensic analyses
  - Verify Forensic PDF includes extra sections

### Task 3: Create History Filters E2E Tests
Create `/tests/e2e/history-filters.spec.ts`:
- **Test**: Search by contract name
  - Create 3 analyses with different names
  - Type search query
  - Verify only matching analysis shown
- **Test**: Risk level filter
  - Filter by "Riesgo Alto"
  - Verify only high-risk analyses shown
  - Verify badge color is red
- **Test**: Date range filter
  - Create analyses on different dates
  - Set dateFrom and dateTo
  - Verify only analyses in range are shown
- **Test**: Combined filters apply AND logic
  - Set search query + risk filter + date range
  - Verify results match all criteria
- **Test**: Empty state shows when no results
  - Search for non-existent contract
  - Verify friendly empty state message
- **Test**: Clear all filters resets everything
  - Apply multiple filters
  - Click "Clear all filters"
  - Verify all filters reset and all analyses shown

### Task 4: Manual Testing Checklist
Create and execute manual QA checklist:

**PDF Export Manual Tests:**
- [ ] Download PDF for Basic analysis (1 credit)
- [ ] Download PDF for Premium analysis (3 credits)
- [ ] Download PDF for Forensic analysis (10 credits)
- [ ] Verify PDF opens correctly in Adobe Reader, Preview, Chrome
- [ ] Verify PDF file size is reasonable (<1MB for typical analysis)
- [ ] Verify branding colors match design (#00dc82 secondary)
- [ ] Verify risk colors match traffic light pattern
- [ ] Verify legal disclaimer appears in footer
- [ ] Verify all hallazgos are present (no truncation)
- [ ] Verify Forensic sections render correctly (if applicable)
- [ ] Test PDF download on Chrome, Firefox, Safari
- [ ] Test PDF download on mobile (iOS Safari, Android Chrome)
- [ ] Verify cached PDF downloads instantly on second attempt

**History Filters Manual Tests:**
- [ ] Search by contract name (case-insensitive)
- [ ] Search with partial match ("contrato" matches "Contrato de Servicios")
- [ ] Filter by "Todos" (shows all analyses)
- [ ] Filter by "Fallidos" (shows only failed analyses)
- [ ] Filter by "Riesgo Alto" (shows only high risk)
- [ ] Filter by "Cuidado" (shows only medium risk)
- [ ] Filter by "Seguro" (shows only low risk)
- [ ] Set date FROM (excludes earlier analyses)
- [ ] Set date TO (excludes later analyses)
- [ ] Set both FROM and TO (range filter)
- [ ] Combine search + risk filter
- [ ] Combine search + risk + date filters
- [ ] Verify empty state when no matches
- [ ] Click "Clear all filters" resets everything
- [ ] Filters persist during page navigation
- [ ] Test date inputs on mobile (iOS Safari date picker)

### Task 5: Performance Testing
**PDF Generation Performance:**
- Measure generation time for analyses with:
  - 5 hallazgos (typical)
  - 20 hallazgos (large)
  - Forensic with all sections (maximum)
- Target: <2 seconds for typical analysis
- Target: <5 seconds for maximum analysis

**History Filter Performance:**
- Test with 10, 50, 100, 500 analyses
- Measure filter application time
- Target: <100ms for filter updates (client-side)

### Task 6: Accessibility Testing
**PDF Accessibility:**
- [ ] Text is selectable in PDF
- [ ] Font size is readable (minimum 10pt)
- [ ] Color contrast meets WCAG AA (risk colors)

**History Page Accessibility:**
- [ ] Date inputs are keyboard accessible
- [ ] Filter buttons have focus states
- [ ] Empty state is announced by screen readers
- [ ] Search input has label

### Task 7: Error Handling Tests
**PDF Export Error Scenarios:**
- [ ] Analysis not found (404)
- [ ] Unauthorized access (401)
- [ ] Rate limit exceeded (429)
- [ ] Storage bucket not configured (500)
- [ ] PDF generation failure (graceful error message)

**History Filter Error Scenarios:**
- [ ] Invalid date format (ignore, show all)
- [ ] FROM date after TO date (handle gracefully)
- [ ] API returns error (show error state)

## Verification Criteria

**Unit Tests:**
- [ ] All unit tests pass (`npm run test:run`)
- [ ] Code coverage includes pdf-generator.ts
- [ ] Mock data covers all edge cases

**E2E Tests:**
- [ ] All E2E tests pass (`npm run test:e2e`)
- [ ] Tests run in CI/CD pipeline
- [ ] Screenshots captured for visual regression

**Manual QA:**
- [ ] All manual test cases pass
- [ ] No visual glitches in PDF layout
- [ ] Filters work on all supported browsers
- [ ] Mobile experience is acceptable

**Performance:**
- [ ] PDF generation <2s typical, <5s maximum
- [ ] History filter updates <100ms
- [ ] No memory leaks during stress testing

## Test Data Requirements

**Test Analyses:**
1. **Basic Analysis** (low risk, 3 hallazgos)
2. **Premium Analysis** (medium risk, 8 hallazgos)
3. **Forensic Analysis** (high risk, 15 hallazgos, full forensic sections)
4. **Failed Analysis** (status: failed, error_message present)
5. **Historical Analysis** (created_at: 6 months ago)
6. **Recent Analysis** (created_at: yesterday)

**Test Users:**
1. **Test User A** (regular user, owns analyses)
2. **Test User B** (regular user, different analyses)
3. **Admin User** (is_admin: true, can view debug info)

## Implementation Notes

**Vitest Unit Test Pattern:**
```typescript
import { describe, it, expect, beforeEach } from 'vitest'
import { generateAnalysisPDF } from '../../server/utils/pdf-generator'
import type { Analysis, AnalysisSummary } from '../../types'

describe('PDF Generator', () => {
  const mockAnalysis: Analysis = { /* ... */ }
  const mockSummary: AnalysisSummary = { /* ... */ }

  it('generates PDF with correct branding', async () => {
    const pdfBuffer = await generateAnalysisPDF(mockAnalysis, mockSummary)
    expect(pdfBuffer).toBeDefined()
    expect(pdfBuffer.length).toBeGreaterThan(1000) // Valid PDF
  })
})
```

**Playwright E2E Pattern:**
```typescript
import { test, expect } from '@playwright/test'

test('user can download analysis PDF', async ({ page }) => {
  await page.goto('/dashboard')
  await page.goto('/analyze/test-analysis-id')
  const [download] = await Promise.all([
    page.waitForEvent('download'),
    page.click('button:has-text("Descargar Reporte")')
  ])
  expect(download.suggestedFilename()).toContain('clarify')
})
```

## Estimated Complexity
**LOW** - Standard testing patterns, well-documented test frameworks

## Dependencies
- Plan 03-01 must be complete (PDF export and filters implemented)
- Test infrastructure already configured (Vitest, Playwright)

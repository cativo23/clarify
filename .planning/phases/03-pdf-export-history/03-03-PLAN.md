---
phase: 03-pdf-export-history
plan: 03
type: gap_closure
wave: 1
depends_on: [03-01]
files_modified:
  - server/utils/pdf-generator.ts
  - pages/history.vue
autonomous: true
gap_closure: true
requirements:
  - PDF-01
  - HISTORY-01
  - HISTORY-02

must_haves:
  truths:
    - "PDF metrics display colored indicators without garbled characters"
    - "PDF footer with disclaimer and page numbers appears on every page"
    - "History date TO filter includes all analyses on the end date"
    - "Clear all filters button visible and functional when filters are active"
  artifacts:
    - path: "server/utils/pdf-generator.ts"
      provides: "PDF generation with Latin-1 compatible symbols and footer on all pages"
      contains: "doc.on('pageAdded')"
    - path: "pages/history.vue"
      provides: "History page with inclusive date filtering and clear all filters button"
      contains: "resetFilters"
  key_links:
    - from: "server/utils/pdf-generator.ts"
      to: "pdfkit document"
      via: "pageAdded event listener"
      pattern: "doc\\.on\\(['\"]pageAdded"
    - from: "pages/history.vue"
      to: "date filter logic"
      via: "matchesDateTo computed with end-of-day timestamp"
      pattern: "setHours\\(23, 59, 59, 999\\)"
---

<objective>
Fix 4 UAT-diagnosed issues in PDF export and history filters: emoji garbled characters, missing PDF footer on most pages, non-inclusive TO date filter, and missing "Clear all filters" button.

Purpose: Close critical usability gaps preventing professional PDF output and efficient history filtering.

Output: Patched pdf-generator.ts and history.vue with all 4 fixes applied.
</objective>

<execution_context>
@/home/cativo23/.claude/get-shit-done/workflows/execute-plan.md
@/home/cativo23/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pdf-export-history/03-UAT.md
@.planning/phases/03-pdf-export-history/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PDF emoji garbled characters (minor)</name>
  <files>server/utils/pdf-generator.ts</files>
  <action>
    Line ~330: Replace Unicode emoji with Latin-1 compatible symbols.

    Current (broken):
    ```typescript
    const metrics = `M√©tricas: üî¥ ${critical} üü° ${medium} üü¢ ${low}`;
    ```

    Fix - Replace emoji with colored circle symbols using text labels:
    ```typescript
    const metrics = `M√©tricas: [ROJAS: ${critical}] [AMARILLAS: ${medium}] [VERDES: ${low}]`;
    ```

    Alternative - Use simple bullet points with risk level text:
    ```typescript
    const metrics = `Hallazgos: ${critical} cr√≠ticos, ${medium} medios, ${low} bajos`;
    ```

    Why: Helvetica font only supports Latin-1 character set. Unicode emoji (üî¥üü°üü¢) have no glyphs, causing garbled output like '√ò=√ù'.

    Keep the risk color logic for the circle/bullet color if using colored text.
  </action>
  <verify>
    1. Generate PDF for an analysis with mixed risk findings
    2. Open PDF and verify metrics section shows readable text (no garbled characters)
    3. ESLint passes: npm run lint
  </verify>
  <done>
    Metrics section displays readable text without garbled characters, using Latin-1 compatible symbols or text labels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix PDF footer missing on most pages (major)</name>
  <files>server/utils/pdf-generator.ts</files>
  <action>
    Lines ~94-108: Footer only drawn at doc.end() for last page. Need to draw footer on EVERY page.

    Current (broken):
    ```typescript
    doc.end();
    // Footer drawing code here - only runs once at end
    ```

    Fix - Use pdfkit's pageAdded event:
    ```typescript
    let pageCount = 0;

    // Add this BEFORE adding content, after creating doc
    doc.on('pageAdded', () => {
      pageCount++;
      const currentPage = doc.page;
      // Draw footer on this page
      currentPage
        .fontSize(8)
        .text('No constituye asesor√≠a legal profesional', 50, currentPage.height - 30, {
          align: 'center',
          width: currentPage.width - 100
        });
      currentPage
        .fontSize(8)
        .text(`${pageCount}`, currentPage.width - 50, currentPage.height - 30, {
          align: 'right'
        });
    });
    ```

    Remove the footer drawing code from doc.end() callback.

    Why: pdfkit with autoFirstPage:false doesn't auto-draw footers. The pageAdded event fires after each page is created, allowing footer rendering on every page.
  </action>
  <verify>
    1. Generate PDF for a Forensic analysis (multiple pages)
    2. Open PDF and scroll through ALL pages
    3. Verify footer with disclaimer and page numbers appears on pages 1, 2, 3, etc. (not just last page)
    4. ESLint passes: npm run lint
  </verify>
  <done>
    Every PDF page displays footer with legal disclaimer and page number.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix date TO filter not inclusive (major)</name>
  <files>pages/history.vue</files>
  <action>
    Line ~410: The TO date comparison creates midnight timestamp, excluding same-day analyses.

    Current (broken):
    ```typescript
    const matchesDateTo = computed(() => {
      if (!dateTo.value) return true;
      const toDate = new Date(dateTo.value);
      return analysisDate <= toDate;
    });
    ```

    Problem: new Date('2026-02-21') creates 2026-02-21T00:00:00. Analysis at 14:30 fails: 2026-02-21T14:30 <= 2026-02-21T00:00 = false.

    Fix - Set TO date to end of day:
    ```typescript
    const matchesDateTo = computed(() => {
      if (!dateTo.value) return true;
      const toDate = new Date(dateTo.value);
      toDate.setHours(23, 59, 59, 999); // End of day
      return analysisDate <= toDate;
    });
    ```

    Why: Setting hours to 23:59:59.999 ensures all analyses on the TO date are included regardless of their timestamp.
  </action>
  <verify>
    1. Navigate to /history page
    2. Set FROM date to 2026-02-17, TO date to 2026-02-21
    3. Verify analyses from Feb 21 (any time of day) are included
    4. ESLint passes: npm run lint
  </verify>
  <done>
    TO date filter includes all analyses on the end date, regardless of time component.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add "Clear all filters" button to main filter bar (major)</name>
  <files>pages/history.vue</files>
  <action>
    Lines ~152-159: Clear button only exists in empty state. Need to add button to main filter bar.

    The resetFilters() function already exists (lines ~446-451):
    ```typescript
    const resetFilters = () => {
      searchQuery.value = '';
      selectedRisk.value = 'all';
      dateFrom.value = '';
      dateTo.value = '';
    };
    ```

    Add button to main filter bar (after the filter inputs, around line 103):
    ```vue
    <div v-if="hasActiveFilters" class="flex items-center gap-2">
      <button
        @click="resetFilters"
        class="px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
      >
        Limpiar filtros
      </button>
    </div>
    ```

    hasActiveFilters computed property should already exist (checks if searchQuery, selectedRisk, dateFrom, or dateTo have values).

    Why: Users need a quick way to reset all filters without manually clearing each field. Button should only show when filters are active.
  </action>
  <verify>
    1. Navigate to /history page
    2. Apply some filters (search, risk, date range)
    3. Verify "Limpiar filtros" button appears in filter bar
    4. Click button
    5. Verify all filters reset and full analysis list displays
    6. ESLint passes: npm run lint
  </verify>
  <done>
    "Limpiar filtros" button visible when filters active, resets all filters when clicked.
  </done>
</task>

</tasks>

<verification>
1. **PDF Generation**: Generate PDF for analysis with multiple risk levels, verify no garbled characters in metrics
2. **PDF Footer**: Open multi-page PDF, verify footer appears on ALL pages (not just last)
3. **Date Filter**: Filter history with TO date = today, verify today's analyses appear
4. **Clear Filters**: Apply filters, click "Limpiar filtros", verify all filters reset
5. ESLint passes: npm run lint
</verification>

<success_criteria>
- [ ] PDF metrics show readable text (no garbled characters like '√ò=√ù')
- [ ] PDF footer with disclaimer visible on every page
- [ ] TO date filter includes all analyses on end date
- [ ] "Limpiar filtros" button visible when filters active
- [ ] All 4 UAT issues closed
</success_criteria>

<output>
After completion, create `.planning/phases/03-pdf-export-history/03-03-SUMMARY.md` documenting the fixes applied and verification results.
</output>

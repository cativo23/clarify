---
phase: 02-tier-selection-ux
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [nuxt.config.ts, components/Dropzone.vue]
autonomous: true
requirements: [TIER-02]
gap_closure: true

must_haves:
  truths:
    - "Files up to 10MB can be uploaded without 'Payload too large' error"
    - "Upload progress bar displays before validation error"
    - "Cancel button is testable during upload"
  artifacts:
    - path: "nuxt.config.ts"
      provides: "Server body size limit configuration"
      contains: "bodyLimit"
    - path: "components/Dropzone.vue"
      provides: "User-friendly file size error message"
      contains: "maxSizeMB"
  key_links:
    - from: "nuxt.config.ts"
      to: "server/api/upload.post.ts"
      via: "nitro bodyLimit config"
      pattern: "nitro:\\s*\\{[\\s\\S]*?bodyLimit"
    - from: "components/Dropzone.vue"
      to: "/api/upload"
      via: "XHR upload with error handling"
      pattern: "xhr\\.open.*POST.*\\/api\\/upload"
---

<objective>
Fix upload payload limit error that rejects 8.45MB files before validation runs.

Purpose: Users reported "Payload too large" error when uploading an 8.45MB PDF. The Nuxt default body limit (1MB) is too low for typical contract PDFs (8+ MB, 25-30 pages). This blocks testing the upload cancel feature.

Output: Increased server body limit in nuxt.config.ts, user-friendly error message in Dropzone.
</objective>

<execution_context>
@/home/cativo23/.claude/get-shit-done/workflows/execute-plan.md
@/home/cativo23/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tier-selection-ux/02-UAT.md
@.planning/diagnosis/phase2-uat-root-cause-analysis.md
@nuxt.config.ts
@server/api/upload.post.ts
@components/Dropzone.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bodyLimit configuration to nuxt.config.ts</name>
  <files>nuxt.config.ts</files>
  <action>
    Add bodyLimit configuration to the nitro section in nuxt.config.ts:

    Find the nitro section (lines 125-138) and add bodyLimit:

    CURRENT (lines 126-138):
    nitro: {
      preset: "vercel",
      routeRules: {
        "/**": {
          headers: {
            "Strict-Transport-Security":
              "max-age=31536000; includeSubDomains; preload",
          },
        },
      },
    },

    REPLACE WITH:
    nitro: {
      preset: "vercel",
      bodyLimit: 10 * 1024 * 1024, // 10MB to match file validation limit
      routeRules: {
        "/**": {
          headers: {
            "Strict-Transport-Security":
              "max-age=31536000; includeSubDomains; preload",
          },
        },
      },
    },

    This increases the server body size limit from the default 1MB to 10MB, matching the validation limit in server/api/upload.post.ts (line 48).
  </action>
  <verify>
    1. Grep nuxt.config.ts for "bodyLimit" - should find "bodyLimit: 10 * 1024 * 1024"
    2. Verify it's inside the nitro section
    3. npm run dev - upload a 8+ MB file - should not get "Payload too large" error
  </verify>
  <done>nuxt.config.ts has bodyLimit: 10MB in nitro section, files up to 10MB can be uploaded</done>
</task>

<task type="auto">
  <name>Task 2: Add user-friendly file size error message in Dropzone</name>
  <files>components/Dropzone.vue</files>
  <action>
    Add user-friendly error handling in components/Dropzone.vue for file size errors:

    Find the error handling in the XHR onerror/onload handlers (search for "xhr.onerror" or "xhr.onload").

    Add specific handling for 413 (Payload Too Large) status:

    In the xhr.onload handler, add:
    if (xhr.status === 413) {
      emit('error', 'El archivo excede el tamaño máximo de 10MB. Por favor sube un documento más pequeño.');
      return;
    }

    Also add a pre-upload size check before initiating the XHR:
    - Get file.size from the selected file
    - Compare against 10 * 1024 * 1024 (10MB)
    - If exceeded, emit error immediately with friendly message instead of attempting upload

    Example:
    const MAX_SIZE_MB = 10;
    const maxSizeBytes = MAX_SIZE_MB * 1024 * 1024;

    if (file.size > maxSizeBytes) {
      emit('error', `El archivo es demasiado grande (máx. ${MAX_SIZE_MB}MB)`);
      return;
    }

    This provides immediate feedback before the upload even starts.
  </action>
  <verify>
    1. Grep Dropzone.vue for "413" - should find status handling
    2. Grep Dropzone.vue for "tamaño máximo" or "demasiado grande" - should find user-friendly message
    3. npm run dev - upload a file > 10MB - should see friendly Spanish error message, not "Payload too large"
  </verify>
  <done>Dropzone.vue has user-friendly file size error handling with Spanish messages, pre-upload size check prevents failed uploads</done>
</task>

</tasks>

<verification>
  1. npm run dev and navigate to /dashboard
  2. Upload an 8+ MB PDF file - should upload successfully without "Payload too large" error
  3. Upload progress bar should display with percentage
  4. Cancel button should appear during upload (test with a moderately large file ~5-8MB)
  5. Try uploading a file > 10MB - should see friendly error message in Spanish before upload starts
</verification>

<success_criteria>
  - [ ] nuxt.config.ts has bodyLimit: 10 * 1024 * 1024 in nitro section
  - [ ] Files up to 10MB upload successfully
  - [ ] Dropzone.vue has pre-upload size check with friendly error message
  - [ ] Dropzone.vue handles 413 status with Spanish error message
  - [ ] Cancel button is testable during upload (no premature payload error)
  - [ ] Upload progress bar displays correctly for large files
</success_criteria>

<output>
After completion, create .planning/phases/02-tier-selection-ux/02-05-SUMMARY.md
</output>

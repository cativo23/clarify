---
phase: 02-tier-selection-ux
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified: [components/AnalysisStatusBadge.vue, composables/useAnalysisStatus.ts, pages/dashboard.vue]
autonomous: false
requirements: [TIER-02]

must_haves:
  truths:
    - "Analysis cards display current status (Pending/Queued/Analyzing/Finalizing/Complete)"
    - "Status updates in real-time without page refresh"
    - "User can navigate away and analysis continues in background"
    - "Completed analyses appear in history with risk level indicator"
  artifacts:
    - path: "components/AnalysisStatusBadge.vue"
      provides: "Reusable status badge with color-coded states and animations"
      min_lines: 80
    - path: "composables/useAnalysisStatus.ts"
      provides: "Supabase Realtime subscription wrapper for live status updates"
      min_lines: 50
  key_links:
    - from: "pages/dashboard.vue"
      to: "components/AnalysisStatusBadge.vue"
      via: "component usage in analysis cards"
      pattern: "AnalysisStatusBadge.*:status"
    - from: "composables/useAnalysisStatus.ts"
      to: "supabase.channel()"
      via: "Realtime subscription to analyses table"
      pattern: "supabase\\.channel.*analyses"
---

<objective>
Implement real-time analysis status display with Supabase Realtime for live updates.

Purpose: Users need to see the progress of their analysis beyond just "processing" - understanding that their analysis is queued, analyzing, or finalizing. The existing dashboard.vue already has Supabase Realtime working; this plan extracts it into a reusable composable and creates a status badge component for consistent display.

Output: New AnalysisStatusBadge.vue component, new useAnalysisStatus.ts composable, and enhanced dashboard.vue analysis cards with detailed status display.
</objective>

<execution_context>
@/home/cativo23/.claude/get-shit-done/workflows/execute-plan.md
@/home/cativo23/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tier-selection-ux/02-CONTEXT.md
@.planning/phases/02-tier-selection-ux/02-RESEARCH.md
@pages/dashboard.vue
@components/AnalysisSelector.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAnalysisStatus composable with Supabase Realtime subscription</name>
  <files>composables/useAnalysisStatus.ts</files>
  <action>
    Create a composable for analysis status tracking with Supabase Realtime:

    Exports:
    - AnalysisStatus type: 'pending' | 'queued' | 'analyzing' | 'finalizing' | 'completed' | 'failed'

    Status mapping (Spanish labels for UI):
    - pending: 'Pendiente'
    - queued: 'En Cola'
    - analyzing: 'Analizando...'
    - finalizing: 'Finalizando...'
    - completed: 'Completado'
    - failed: 'Fallido'

    Status colors (Tailwind classes):
    - pending: 'bg-slate-400'
    - queued: 'bg-slate-500 animate-pulse'
    - analyzing: 'bg-secondary animate-pulse'
    - finalizing: 'bg-accent-indigo animate-pulse'
    - completed: 'bg-risk-low'
    - failed: 'bg-red-500'

    Functions:
    - subscribeToAnalysis(analysisId: string, userId: string, callback: (analysis: Analysis) => void): () => void
      - Creates Supabase channel: `analysis-${analysisId}`
      - Filters: event='UPDATE', table='analyses', filter=`id=eq.${analysisId}`
      - Calls callback with payload.new on changes
      - Returns unsubscribe function

    - getStatusLabel(status: string): string - Returns Spanish label
    - getStatusColor(status: string): string - Returns Tailwind classes
    - getStatusIcon(status: string): Component - Returns appropriate Lucide icon

    Cleanup:
    - Track active channels in Map<analysisId, channel>
    - onUnmounted: unsubscribe all channels
  </action>
  <verify>File exists at /home/cativo23/projects/personal/clarify/composables/useAnalysisStatus.ts with subscribeToAnalysis, getStatusLabel, getStatusColor functions</verify>
  <done>useAnalysisStatus.ts composable created with Supabase Realtime subscription, status mappings, and proper cleanup</done>
</task>

<task type="auto">
  <name>Task 2: Create AnalysisStatusBadge component with color-coded states</name>
  <files>components/AnalysisStatusBadge.vue</files>
  <action>
    Create a reusable status badge component:

    Props:
    - status: string (required) - Analysis status
    - size?: 'sm' | 'md' | 'lg' (default: 'md')
    - showPulse?: boolean (default: true for active states)

    Template:
    - Badge container: inline-flex items-center gap-2 px-3 py-1.5 rounded-full
    - Status dot: w-2 h-2 rounded-full with dynamic bg color
    - Animate pulse: animate-pulse class for pending/queued/analyzing/finalizing
    - Status label: text-xs font-black uppercase tracking-wider

    Size variants:
    - sm: px-2 py-0.5, text-[9px], dot w-1.5 h-1.5
    - md: px-3 py-1.5, text-[10px], dot w-2 h-2
    - lg: px-4 py-2, text-xs, dot w-2.5 h-2.5

    Background colors per status (subtle tint):
    - pending: bg-slate-100 dark:bg-slate-800, text-slate-600 dark:text-slate-400
    - queued: bg-slate-100 dark:bg-slate-800, text-slate-700 dark:text-slate-300
    - analyzing: bg-secondary/10, text-secondary
    - finalizing: bg-accent-indigo/10, text-accent-indigo
    - completed: bg-risk-low/10, text-risk-low
    - failed: bg-red-500/10, text-red-500

    Use getStatusLabel and getStatusColor from useAnalysisStatus composable
  </action>
  <verify>File exists at /home/cativo23/projects/personal/clarify/components/AnalysisStatusBadge.vue with status prop, size variants, and color-coded badge</verify>
  <done>AnalysisStatusBadge.vue created with color-coded status display, size variants, and pulse animations for active states</done>
</task>

<task type="auto">
  <name>Task 3: Enhance dashboard.vue analysis cards with status badges and realtime updates</name>
  <files>pages/dashboard.vue</files>
  <action>
    Enhance the existing dashboard.vue to use new status components:

    1. Import new components and composable:
       - import { useAnalysisStatus } from '~/composables/useAnalysisStatus'
       - import AnalysisStatusBadge from '~/components/AnalysisStatusBadge.vue'

    2. Replace inline status display in analysis cards:
       - Current: Manual span with getStatusLabel, getStatusTextClass
       - New: <AnalysisStatusBadge :status="analysis.status" size="sm" />
       - Apply to both completed/failed cards and processing/pending cards

    3. Enhance status polling (existing realtime already works):
       - Current: dashboard.vue has setupRealtimeSubscription that updates analyses array
       - Keep existing logic - it already uses Supabase Realtime correctly
       - Consider extracting to useAnalysisStatus.subscribeToAnalysis for cleaner code

    4. Add detailed 5-state display support:
       - Update getStatusLabel to handle all 5 states: pending, queued, analyzing, finalizing, completed
       - Ensure getStatusColor returns appropriate colors for each state
       - Add status icon based on state (ClockIcon for pending, QueueIcon for queued, etc.)

    5. Improve placeholder card during analysis:
       - Current: Shows "Procesando..." or "Pendiente"
       - New: Show specific status (queued, analyzing, finalizing) with appropriate icon
       - Keep spinner animation for analyzing state
       - Keep pulse animation for queued state

    6. Verify auto-advance behavior:
       - After handleAnalyze completes, user should see new analysis in list with "pending" status
       - Realtime should update status as it changes in database
       - No manual refresh needed
  </action>
  <verify>
    1. Grep for "AnalysisStatusBadge" in dashboard.vue
    2. Grep for "useAnalysisStatus" in dashboard.vue
    3. Run npm run dev and trigger an analysis - verify status updates without page refresh
    4. Verify all 5 states display correctly with appropriate colors
  </verify>
  <done>dashboard.vue analysis cards use AnalysisStatusBadge component with live status updates via Supabase Realtime - user sees Pending → Queued → Analyzing → Finalizing → Complete progression</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 4: Verify real-time status display and Supabase Realtime integration</name>
  <files>pages/dashboard.vue</files>
  <action>
    Human verification required - see verification steps below.
  </action>
  <verify>
    1. Run npm run dev and navigate to /dashboard
    2. Upload a document and start an analysis
    3. Verify the new analysis appears in "Análisis Recientes" with status "Pendiente"
    4. Watch status update to "Analizando..." (should show spinner/pulse)
    5. Navigate away from dashboard (e.g., to /credits) and return after 1-2 minutes
    6. Verify analysis shows "Completado" with risk level color
    7. Click on completed analysis - should navigate to results page

    Status color verification:
    - Pending: Gray badge
    - Analyzing: Green badge with pulse animation
    - Completed: Green badge (risk-low color)
    - Failed: Red badge
  </verify>
  <done>Status badge displays correctly, updates in real-time without page refresh, and all 5 states render with appropriate colors and animations</done>
</task>

</tasks>

<verification>
  1. Run npm run dev and navigate to /dashboard
  2. Start a new analysis - verify status shows "Pendiente" initially
  3. Wait for analysis to start - status should update to "Analizando..." without refresh
  4. Navigate away and back - status should persist and update
  5. Verify completed analysis shows risk level with appropriate color
  6. Check browser console for no Supabase Realtime errors
</verification>

<success_criteria>
  - [ ] useAnalysisStatus.ts composable exists with Supabase Realtime subscription
  - [ ] AnalysisStatusBadge.vue displays status with color-coded badge and pulse animation
  - [ ] dashboard.vue analysis cards use AnalysisStatusBadge component
  - [ ] Status updates in real-time without page refresh
  - [ ] All 5 states supported: Pending → Queued → Analyzing → Finalizing → Complete
  - [ ] Analysis placeholder appears in history list immediately after submission
  - [ ] Realtime subscription cleans up properly on component unmount
  - [ ] Dark mode styling works for status badges
</success_criteria>

<output>
After completion, create .planning/phases/02-tier-selection-ux/02-03-SUMMARY.md
</output>

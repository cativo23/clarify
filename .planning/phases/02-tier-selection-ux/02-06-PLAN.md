---
phase: 02-tier-selection-ux
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [database/migrations/20260223000001_fix_realtime_replica_identity.sql, pages/dashboard.vue]
autonomous: true
requirements: [TIER-02]
gap_closure: true

must_haves:
  truths:
    - "Analysis status updates from 'Pendiente' to 'Analizando' without page refresh"
    - "Status updates persist when navigating away and returning"
    - "Polling fallback works if realtime subscription fails"
  artifacts:
    - path: "database/migrations/20260223000001_fix_realtime_replica_identity.sql"
      provides: "REPLICA IDENTITY FULL for analyses table"
      contains: "ALTER TABLE analyses REPLICA IDENTITY FULL"
    - path: "pages/dashboard.vue"
      provides: "Polling fallback for pending analyses"
      contains: "setInterval" or "useInterval"
  key_links:
    - from: "pages/dashboard.vue"
      to: "supabase.channel()"
      via: "Realtime subscription setup"
      pattern: "setupRealtimeSubscription"
    - from: "pages/dashboard.vue"
      to: "/api/analyses"
      via: "Polling refresh for pending statuses"
      pattern: "fetchAnalyses.*pending"
---

<objective>
Fix analysis status not updating in real-time (blocker issue).

Purpose: Users reported status stuck on "Pendiente" even after page refresh. Root cause: missing REPLICA IDENTITY FULL in database migration prevents Supabase Realtime from capturing UPDATE events correctly, and no polling fallback exists when realtime fails.

Output: Database migration for REPLICA IDENTITY FULL, polling fallback in dashboard.vue.
</objective>

<execution_context>
@/home/cativo23/.claude/get-shit-done/workflows/execute-plan.md
@/home/cativo23/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tier-selection-ux/02-UAT.md
@.planning/diagnosis/phase2-uat-root-cause-analysis.md
@pages/dashboard.vue
@database/migrations/20260216000003_add_async_analysis_support.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration to enable REPLICA IDENTITY FULL for analyses table</name>
  <files>database/migrations/20260223000001_fix_realtime_replica_identity.sql</files>
  <action>
    Create a new migration file at database/migrations/20260223000001_fix_realtime_replica_identity.sql:

    Content:
    -- Migration: Fix Realtime REPLICA IDENTITY for analyses table
    -- Date: 2026-02-23
    -- Description: Enable REPLICA IDENTITY FULL for Supabase Realtime UPDATE events
    -- Issue: Phase 2 UAT Issue #5 (blocker) - status not updating

    -- Enable REPLICA IDENTITY FULL for analyses table
    -- This ensures Postgres replicates all changed columns in UPDATE events,
    -- not just the primary key
    ALTER TABLE analyses REPLICA IDENTITY FULL;

    -- Verify the change (optional, for debugging)
    -- SELECT relname, relreplident FROM pg_class WHERE relname = 'analyses';

    Note: The existing migration (20260216000003) already added the table to supabase_realtime
    publication, but without REPLICA IDENTITY FULL, UPDATE events only replicate the PK.
  </action>
  <verify>
    1. File exists at database/migrations/20260223000001_fix_realtime_replica_identity.sql
    2. Contains "ALTER TABLE analyses REPLICA IDENTITY FULL"
    3. Run npm run db:migrate - should apply successfully
    4. Verify in Supabase SQL editor: SELECT relreplident FROM pg_class WHERE relname = 'analyses' - should return 'f' (FULL)
  </verify>
  <done>Migration created and applied, analyses table has REPLICA IDENTITY FULL for complete UPDATE event replication</done>
</task>

<task type="auto">
  <name>Task 2: Add polling fallback in dashboard.vue for pending analyses</name>
  <files>pages/dashboard.vue</files>
  <action>
    Add polling fallback in pages/dashboard.vue to refresh pending analyses when realtime fails:

    After the setupRealtimeSubscription function (around line 1039), add a polling mechanism:

    ADD after line 1039 (after setupRealtimeSubscription):

    const startStatusPolling = () => {
      // Poll every 5 seconds for analyses with pending/processing status
      setInterval(async () => {
        const hasPendingAnalyses = analyses.value.some(
          (a) => a.status === 'pending' || a.status === 'processing' || a.status === 'queued'
        );

        if (hasPendingAnalyses) {
          console.log('Polling: Refreshing pending analyses...');
          await fetchAnalyses();
        }
      }, 5000);
    };

    // Start polling after realtime subscription
    if (currentUserId.value) {
      startStatusPolling();
    }

    Also enhance the realtime subscription status handler (lines 1031-1038) to detect failures:

    UPDATE lines 1035-1036:
    } else if (status === "CHANNEL_ERROR" || status === "TIMED_OUT") {
      console.error("Realtime subscription error:", status);
      // Trigger more aggressive polling when realtime fails
      console.log("Realtime failed, relying on polling fallback");
    }

    The polling acts as a fallback when:
    1. Realtime subscription fails to connect
    2. Realtime events are not received (network issues)
    3. Database REPLICA IDENTITY was not configured
  </action>
  <verify>
    1. Grep dashboard.vue for "startStatusPolling" - should find the function
    2. Grep dashboard.vue for "setInterval" - should find the 5000ms polling
    3. npm run dev - trigger an analysis - status should update from Pendiente -> Analizando -> Completado
    4. Verify updates happen without page refresh
    5. Check browser console for "Polling: Refreshing pending analyses..." messages
  </verify>
  <done>dashboard.vue has polling fallback that refreshes pending analyses every 5 seconds, status updates work even if realtime fails</done>
</task>

<task type="auto">
  <name>Task 3: Verify BullMQ worker is processing analysis jobs</name>
  <files>server/workers/analysis-worker.ts</files>
  <action>
    Verify the analysis worker is running and processing jobs:

    1. Check if server/workers/analysis-worker.ts exists
    2. Verify it's being started (check package.json scripts or a worker start script)
    3. The worker should:
       - Connect to Redis (using config from runtimeConfig)
       - Create a QueueProcessor for the 'analysis' queue
       - Process jobs by calling the analysis logic
       - Update analysis status in database: pending -> processing -> completed

    If the worker file doesn't exist or isn't being started, this is a separate infra issue.
    For now, ensure the worker logic updates status correctly:

    Status progression in worker:
    - Start: status = 'pending' (set by /api/analyze endpoint)
    - Processing: status = 'processing' or 'analyzing' (set when job starts)
    - Complete: status = 'completed' (set when analysis finishes)
    - Failed: status = 'failed' + error_message (set on error)

    Add logging in the worker for debugging:
    console.log('[Worker] Processing analysis job:', job.id, job.data.analysisId);
    console.log('[Worker] Updating status to:', newStatus);
  </action>
  <verify>
    1. Verify server/workers/analysis-worker.ts exists
    2. Check if worker process is running (in dev: check terminal for worker startup)
    3. Trigger an analysis - check worker logs for processing messages
    4. If worker not running, note: "Worker must be started for status updates to work"
  </verify>
  <done>Worker verified running, or documented setup required for worker startup</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 4: Verify analysis status updates in real-time</name>
  <files>pages/dashboard.vue</files>
  <action>
    Human verification required - see verification steps below.
  </action>
  <verify>
    1. Run npm run dev and navigate to /dashboard
    2. Upload a document and start an analysis
    3. Verify the new analysis appears in "An√°lisis Recientes" with status "Pendiente" (gray badge)
    4. WITHOUT refreshing the page, watch for status change to "Analizando..." (green badge with pulse)
    5. Wait for analysis to complete (2-5 minutes) - status should update to "Completado" (green badge)
    6. Navigate to /credits and back to /dashboard - status should still show correctly
    7. Open browser console - verify no Supabase Realtime errors
    8. Check for polling messages: "Polling: Refreshing pending analyses..."

    Expected flow:
    - T=0s: Analysis submitted, shows "Pendiente"
    - T=5-10s: Status updates to "Analizando..." (via realtime or polling)
    - T=2-5min: Status updates to "Completado" with risk level
    - Navigate away/back: Status persists correctly
  </verify>
  <done>Status updates from Pendiente -> Analizando -> Completado without page refresh, polling fallback working, realtime subscription active</done>
</task>

</tasks>

<verification>
  1. Run npm run db:migrate - verify migration applies successfully
  2. Verify in Supabase dashboard: analyses table has REPLICA IDENTITY FULL
  3. npm run dev and trigger a new analysis
  4. Status updates from "Pendiente" -> "Analizando..." -> "Completado" without page refresh
  5. Browser console shows realtime subscription status: "SUBSCRIBED"
  6. Browser console shows polling messages for pending analyses
  7. Navigate away and back - status persists and updates correctly
</verification>

<success_criteria>
  - [ ] Migration 20260223000001_fix_realtime_replica_identity.sql created and applied
  - [ ] analyses table has REPLICA IDENTITY FULL (verify via SQL query)
  - [ ] dashboard.vue has startStatusPolling function with 5-second interval
  - [ ] Polling refreshes only when pending analyses exist
  - [ ] Realtime subscription logs "SUBSCRIBED" status
  - [ ] Analysis status updates without page refresh (Pendiente -> Analizando -> Completado)
  - [ ] Worker is running and processing jobs (or documented for setup)
</success_criteria>

<output>
After completion, create .planning/phases/02-tier-selection-ux/02-06-SUMMARY.md
</output>

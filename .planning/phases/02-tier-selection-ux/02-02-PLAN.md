---
phase: 02-tier-selection-ux
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [components/Dropzone.vue, composables/useUploadProgress.ts]
autonomous: true
requirements: [UPLOAD-02]

must_haves:
  truths:
    - "User sees percentage progress during file upload (0-100%)"
    - "User sees step indicators showing current stage (Subiendo → Validando → Completado)"
    - "Upload progress displayed inline within dropzone component"
    - "UI auto-advances to tier selector after upload completes"
  artifacts:
    - path: "components/Dropzone.vue"
      provides: "File upload with progress bar and step indicators"
      min_lines: 200
    - path: "composables/useUploadProgress.ts"
      provides: "Upload logic with XHR progress events and abort support"
      min_lines: 60
  key_links:
    - from: "components/Dropzone.vue"
      to: "/api/upload"
      via: "XHR POST with progress events"
      pattern: "xhr\\.open.*POST.*\\/api\\/upload"
    - from: "pages/dashboard.vue"
      to: "components/Dropzone.vue"
      via: "uploadProgress and isUploading props"
      pattern: "uploadProgress|isUploading"
---

<objective>
Enhance Dropzone with detailed upload progress including percentage bar and step indicators.

Purpose: Users need clear feedback during file upload similar to Google Drive - knowing both the percentage complete and what stage the process is in (uploading vs validating vs complete). This reduces anxiety and perceived wait time.

Output: Enhanced Dropzone.vue with step indicators, improved progress animation, and new useUploadProgress composable for reusable upload logic.
</objective>

<execution_context>
@/home/cativo23/.claude/get-shit-done/workflows/execute-plan.md
@/home/cativo23/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tier-selection-ux/02-CONTEXT.md
@.planning/phases/02-tier-selection-ux/02-RESEARCH.md
@components/Dropzone.vue
@pages/dashboard.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useUploadProgress composable with XHR progress tracking</name>
  <files>composables/useUploadProgress.ts</files>
  <action>
    Create a composable for file upload with progress tracking:

    Exports:
    - uploadProgress: ref<number> (0-100)
    - isUploading: ref<boolean>
    - uploadError: ref<string | null>
    - abortController: ref<AbortController | null>

    Functions:
    - uploadFile(file: File, url: string): Promise<{ success: boolean; file_url?: string; error?: string }>
      - Uses XMLHttpRequest (not fetch) for progress events
      - xhr.upload.addEventListener('progress', e) - updates uploadProgress on e.loaded/e.total
      - xhr.onload - resolves with JSON response on status 200
      - xhr.onerror - rejects with error
      - Stores abortController for cancellation support

    - cancelUpload(): void
      - Calls abortController.abort() if exists
      - Resets progress state

    - resetProgress(): void
      - Sets uploadProgress to 0, isUploading to false, uploadError to null

    Error handling:
    - Capture XHR statusText on error
    - Set uploadError with user-friendly message
  </action>
  <verify>File exists at /home/cativo23/projects/personal/clarify/composables/useUploadProgress.ts with uploadFile, cancelUpload, and resetProgress functions</verify>
  <done>useUploadProgress.ts composable created with XHR-based upload, progress events, abort support, and error handling</done>
</task>

<task type="auto">
  <name>Task 2: Enhance Dropzone with step indicators and improved progress UI</name>
  <files>components/Dropzone.vue</files>
  <action>
    Enhance the existing Dropzone.vue component with step indicators:

    1. Add upload steps definition:
       - const uploadSteps = [
           { key: 'uploading', label: 'Subiendo', threshold: 0 },
           { key: 'validating', label: 'Validando', threshold: 90 },
           { key: 'complete', label: 'Completado', threshold: 100 }
         ]
       - currentStep computed: returns step where progress >= threshold (reverse sorted)

    2. Enhance progress bar section (inside Selected File Preview):
       - Add step indicator row ABOVE progress bar
       - 3 steps displayed horizontally with gap-2
       - Each step: circle (w-6 h-6) + label (text-[9px] font-black uppercase)
       - Active step: bg-secondary text-white circle
       - Completed step: bg-secondary/20 text-secondary circle
       - Pending step: bg-slate-200 text-slate-400 circle
       - Connect circles with horizontal lines (w-full h-0.5 bg-slate-200)

    3. Improve progress bar styling:
       - Keep existing percentage display
       - Add gradient bar (from-secondary to-accent-indigo)
       - Add smooth transition (duration-300 ease-out)
       - Increase height slightly (h-2 -> h-2.5 for better visibility)

    4. Add cancel button during upload:
       - Show when isUploading && progress < 100
       - Button: w-8 h-8 rounded-lg bg-slate-100 hover:bg-risk-high text-slate-500 hover:text-white
       - Icon: X icon or Stop icon
       - Calls cancelUpload() from composable

    5. Props update:
       - Keep: modelValue, uploadProgress, isUploading
       - Add: onCancel?: () => void (optional cancel handler)
  </action>
  <verify>
    1. Grep for "uploadSteps" in Dropzone.vue
    2. Grep for "currentStep" in Dropzone.vue
    3. Verify step indicator HTML with 3 circles and labels
    4. Verify cancel button appears during upload
  </verify>
  <done>Dropzone.vue enhanced with 3-step indicators (Subiendo/Validando/Completado), improved progress bar, and cancel button</done>
</task>

<task type="auto">
  <name>Task 3: Integrate upload progress composable into Dropzone</name>
  <files>components/Dropzone.vue</files>
  <action>
    Integrate the useUploadProgress composable into Dropzone:

    1. Import and setup composable:
       - const { uploadProgress, isUploading, uploadError, uploadFile, cancelUpload, resetProgress } = useUploadProgress()
       - Remove local isUploading ref (use composable's)
       - Remove local uploadProgress ref (use composable's)

    2. Update handleFileChange and handleDrop:
       - After file validation, call uploadFile(file, '/api/upload')
       - On success: emit('update:modelValue', file) and emit('uploaded', { file_url: response.file_url })
       - On error: emit('error', uploadError.value)

    3. Update clearFile function:
       - Call resetProgress() before clearing file
       - Ensures progress state resets when user removes file

    4. Wire cancel button:
       - @click="cancelUpload"
       - Emit 'cancelled' event after cancellation

    5. Watch uploadProgress for completion:
       - watch(uploadProgress, (newVal) => { if (newVal === 100) emit('complete') })
       - Auto-advance signal for parent component

    6. Update error display:
       - Show uploadError in addition to existing validation error
       - Style with bg-risk-high/10 border-risk-high (same as existing error)
  </action>
  <verify>
    1. Grep for "useUploadProgress" in Dropzone.vue
    2. Grep for "emit.*uploaded" in Dropzone.vue
    3. Verify cancelUpload called on cancel button click
    4. Verify resetProgress called in clearFile
  </verify>
  <done>Dropzone.vue fully integrated with useUploadProgress composable - upload triggers progress events, emits uploaded event with file_url on success, cancel button aborts upload</done>
</task>

</tasks>

<verification>
  1. Run npm run dev and navigate to /dashboard
  2. Select a PDF file - upload should start automatically
  3. Verify progress percentage increases from 0% to 100%
  4. Verify step indicators: "Subiendo" active during 0-89%, "Validando" at 90-99%, "Completado" at 100%
  5. Click cancel button during upload - upload should stop and progress should reset
  6. Verify "Completado" state shows briefly before tier selector appears
</verification>

<success_criteria>
  - [ ] useUploadProgress.ts composable exists with uploadFile, cancelUpload, resetProgress
  - [ ] Dropzone.vue displays 3-step indicators (Subiendo → Validando → Completado)
  - [ ] Progress bar shows percentage with smooth gradient animation
  - [ ] Cancel button appears during upload and aborts the upload
  - [ ] Dropzone emits 'uploaded' event with { file_url } on success
  - [ ] Dropzone emits 'complete' event when progress reaches 100%
  - [ ] Error state displays upload errors (not just validation errors)
  - [ ] Component supports dark mode styling
</success_criteria>

<output>
After completion, create .planning/phases/02-tier-selection-ux/02-02-SUMMARY.md
</output>
